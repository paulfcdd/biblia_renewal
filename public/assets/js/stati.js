!function(t,e){"function"==typeof define&&define.amd?define([],e):"undefined"!=typeof module&&module.exports?module.exports=e():t.ReconnectingWebSocket=e()}(this,function(){function t(e,n,o){function i(t,e){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,e),n}var c={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};for(var a in o||(o={}),c)this[a]=void 0!==o[a]?o[a]:c[a];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var r,s=this,u=!1,d=!1,l=document.createElement("div");l.addEventListener("open",function(t){s.onopen(t)}),l.addEventListener("close",function(t){s.onclose(t)}),l.addEventListener("connecting",function(t){s.onconnecting(t)}),l.addEventListener("message",function(t){s.onmessage(t)}),l.addEventListener("error",function(t){s.onerror(t)}),this.addEventListener=l.addEventListener.bind(l),this.removeEventListener=l.removeEventListener.bind(l),this.dispatchEvent=l.dispatchEvent.bind(l),this.open=function(e){r=new WebSocket(s.url,n||[]),e||l.dispatchEvent(i("connecting")),(s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",s.url);var o=r,c=setTimeout(function(){(s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),d=!0,o.close(),d=!1},s.timeoutInterval);r.onopen=function(){clearTimeout(c),(s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onopen",s.url),s.protocol=r.protocol,s.readyState=WebSocket.OPEN,s.reconnectAttempts=0;var n=i("open");n.isReconnect=e,e=!1,l.dispatchEvent(n)},r.onclose=function(n){if(clearTimeout(c),r=null,u)s.readyState=WebSocket.CLOSED,l.dispatchEvent(i("close"));else{s.readyState=WebSocket.CONNECTING;var o=i("connecting");o.code=n.code,o.reason=n.reason,o.wasClean=n.wasClean,l.dispatchEvent(o),e||d||((s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onclose",s.url),l.dispatchEvent(i("close")));var c=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++,s.open(!0)},c>s.maxReconnectInterval?s.maxReconnectInterval:c)}},r.onmessage=function(e){(s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",s.url,e.data);var n=i("message");n.data=e.data,l.dispatchEvent(n)},r.onerror=function(e){(s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","onerror",s.url,e),l.dispatchEvent(i("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(r)return(s.debug||t.debugAll)&&console.debug("ReconnectingWebSocket","send",s.url,e),r.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(t,e){void 0===t&&(t=1e3),u=!0,r&&r.close(t,e)},this.refresh=function(){r&&r.close()}}return t.prototype.onopen=function(){},t.prototype.onclose=function(){},t.prototype.onconnecting=function(){},t.prototype.onmessage=function(){},t.prototype.onerror=function(){},t.debugAll=!1,t.CONNECTING=WebSocket.CONNECTING,t.OPEN=WebSocket.OPEN,t.CLOSING=WebSocket.CLOSING,t.CLOSED=WebSocket.CLOSED,t}),$(function(){"undefined"!=typeof stati_type&&StatisticsModule.runerPage("type",stati_type,"sub","undefined"!=typeof stati_type?stati_sub:""),StatisticsModule.runer()});var StatisticsModule=function(){var t=function(t,e){t.length&&$.ajax({type:"POST",url:"https://stat.azbyka.ru/batch-query/",data:JSON.stringify(t),success:function(t){var n=JSON.parse(JSON.stringify(t));$.each(n,function(t,n){$.each(e,function(e,o){if(o.key===t)return $(".abc-counter").filter(function(){if("biblia"===$(this).attr("data-project")&&$(this).attr("data-type-1")===o.type1&&$(this).attr("data-id-1")===o.id1&&$(this).attr("data-type-2")===o.type2&&$(this).attr("data-id-2")===o.id2)return n.viewCounter||(n.viewCounter=0),n.onlineCounter||(n.onlineCounter=0),$(this).find(".abc-counter-views").text(i(n.viewCounter)),$(this).find(".abc-counter-views").attr("title","Р’СЃРµРіРѕ РїСЂРѕСЃРјРѕС‚СЂРѕРІ: "+n.viewCounter.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")),$(this).find(".abc-counter-now").text(n.onlineCounter.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")),!0}),!1})})}})},e=function(t,e,c,a){var r="https://stat.azbyka.ru/counters/"+o(t,e,c,a,!1,"/"),s=new XMLHttpRequest;s.open("POST",r,!0),s.onreadystatechange=function(){if(4===s.readyState&&200===s.status&&s.responseText){var o=JSON.parse(s.responseText);o.success&&n(t,e,c,a,i(o.data.value),o.data.now+1)}},s.send()},n=function(t,e,n,o,c="",a=""){$(".abc-counter").filter(function(){"biblia"===$(this).attr("data-project")&&$(this).attr("data-type-1")===t&&$(this).attr("data-id-1")===e&&$(this).attr("data-type-2")===n&&$(this).attr("data-id-2")===o&&(c||(c=0),a||(a=0),c&&($(this).find(".abc-counter-views").text(i(c)),$(this).find(".abc-counter-views").attr("title","Р’СЃРµРіРѕ РїСЂРѕСЃРјРѕС‚СЂРѕРІ: "+c.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 "))),a&&$(this).find(".abc-counter-now").text(a.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")))})},o=function(t,e,n,o,i,c){var a="";return i&&(a="/"),a=a+"project"+c+"biblia",e&&t&&(a=a+"/"+t+c+e,o&&n&&(a=a+"/"+n+c+o)),a},i=function(t){return t=(t=parseFloat(t))>1e6?(t/=1e6).toFixed(1)+"Рњ":t>1e4?(t/=1e3).toFixed()+"Рљ":t>1e3?(t/=1e3).toFixed(1)+"Рљ":function(t,e="В "){t||(t="0");for(var n=(t+="").split("."),o=n[0],i=n.length>1?"."+n[1]:"",c=/(\d+)(\d{3})/;c.test(o);)o=o.replace(c,"$1"+e+"$2");return o+i}(t)};return{runerPage:function(t,n,i,c){!function(t,n,i,c){if(t&&n){e(t,n,i,c),request="wss://stat.azbyka.ru/realtime-view/"+o(t,n,i,c,!1,"/");try{var a=new ReconnectingWebSocket(request,null,{timeoutInterval:1e4,reconnectInterval:5e3,maxReconnectAttempts:20});a.onopen=function(){}}catch(t){console.error(t.name+": "+t.message)}}}(t,n,i,c)},runer:function(e,n,i,c){!function(){var e=[],n=[],i=[];$(".abc-counter").each(function(){var t=$(this),c=t.attr("data-type-1"),a=t.attr("data-id-1"),r=t.attr("data-type-2"),s=t.attr("data-id-2"),u=o(c,a,r,s,!0,":"),d=o(c,a,r,s,!0,"/");e.push(u),n.push(d),i.push({key:u,keyx:d,type1:c,id1:a,type2:r,id2:s})}),t(e,i);var c="wss://stat.azbyka.ru/updates";c+="?time=3000";var a=new ReconnectingWebSocket(c,null,{timeoutInterval:1e4,reconnectInterval:5e3,maxReconnectAttempts:20});a.onopen=function(){a.send(JSON.stringify(n))},a.onmessage=function(t){var e=JSON.parse(t.data);$.each(e,function(t,e){$.each(i,function(n,o){if(o.keyx===t)return $(".abc-counter").filter(function(){if("biblia"===$(this).attr("data-project")&&$(this).attr("data-type-1")===o.type1&&$(this).attr("data-id-1")===o.id1&&$(this).attr("data-type-2")===o.type2&&$(this).attr("data-id-2")===o.id2)return $(this).find(".abc-counter-now").text(e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")),!0}),!1})})}}()}}}();
